<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DiagnÃ³stico â€” CÃ¢mera no navegador</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { color-scheme: dark; }
    body { padding: 16px; background:#0b1020; color:#e6e9f2; }
    .card { background:#11172b; border:1px solid #1c2744; }
    .log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0b1328; border:1px solid #223056; border-radius:8px; padding:10px; max-height:40vh; overflow:auto; }
    video { width: 100%; height: auto; background: #000; border-radius: 12px; }
    .hint { color:#aab3c9; }
  </style>
</head>
<body>
  <div class="container py-3">
    <div class="card shadow">
      <div class="card-body">
        <h1 class="h5 mb-3">DiagnÃ³stico â€” CÃ¢mera embutida</h1>
        <div class="row g-3">
          <div class="col-12 col-md-7">
            <div class="mb-2">
              <div><strong>Contexto:</strong></div>
              <ul class="mb-2">
                <li>HTTPS: <span id="https">?</span></li>
                <li>secureContext: <span id="secure">?</span></li>
                <li>getUserMedia: <span id="gum">?</span></li>
                <li>Navegador: <span id="ua">?</span></li>
              </ul>
            </div>
            <video id="preview" playsinline muted></video>
            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-primary" id="btnStart">Iniciar cÃ¢mera (embutida)</button>
              <button class="btn btn-outline-secondary" id="btnStop" disabled>Parar</button>
              <label class="btn btn-outline-secondary mb-0">
                Foto (fallback) <input id="file" type="file" accept="image/*" capture="environment" hidden>
              </label>
            </div>
          </div>
          <div class="col-12 col-md-5">
            <div class="mb-2"><strong>Passos para abrir no celular:</strong></div>
            <ol class="hint">
              <li>Abra este arquivo no <b>Chrome</b> (Android) ou <b>Safari</b> (iPhone), nÃ£o no visualizador do app.</li>
              <li>No Android: toque no cadeado/Ã­cone de site â†’ PermissÃµes â†’ CÃ¢mera: <b>Permitir</b>.</li>
              <li>No iPhone: Ajustes â†’ Safari â†’ CÃ¢mera (Perguntar/Permitir). No site: AA â†’ ConfiguraÃ§Ãµes do Site â†’ CÃ¢mera: <b>Permitir</b>.</li>
              <li>Sem HTTPS, a cÃ¢mera embutida pode nÃ£o abrir. Use <b>Foto (fallback)</b>.</li>
            </ol>
            <div class="mb-2"><strong>Logs</strong></div>
            <div class="log" id="log"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const log = (m)=> { const el = $('#log'); el.textContent += (m + "\\n"); el.scrollTop = el.scrollHeight; };

    // Mostrar contexto
    $('#https').textContent  = location.protocol === 'https:' ? 'sim' : 'nÃ£o';
    $('#secure').textContent = (window.isSecureContext ? 'sim' : 'nÃ£o');
    $('#gum').textContent    = (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) ? 'sim' : 'nÃ£o';
    $('#ua').textContent     = navigator.userAgent;

    let stream = null;
    let track  = null;

    async function startCam() {
      if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) {
        log('âŒ Seu navegador nÃ£o expÃµe navigator.mediaDevices.getUserMedia.');
        alert('CÃ¢mera embutida nÃ£o suportada. Use Foto (fallback).');
        return;
      }
      if (!window.isSecureContext) {
        log('âš ï¸ Contexto nÃ£o seguro. Muitos navegadores bloqueiam a cÃ¢mera embutida sem HTTPS.');
      }
      try {
        // 1Âª tentativa: traseira por largura ideal
        log('Tentando abrir com facingMode: environment (ideal), width ideal 800â€¦');
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' }, width: { ideal: 800 } },
          audio: false
        });
      } catch (e1) {
        log('Falhou tentativa 1: ' + e1.name + ' â€” ' + e1.message);
        // 2Âª tentativa: sem facingMode, apenas video:true
        try {
          log('Tentando abrir com video:trueâ€¦');
          stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        } catch (e2) {
          log('Falhou tentativa 2: ' + e2.name + ' â€” ' + e2.message);
          alert('NÃ£o consegui abrir a cÃ¢mera embutida. Use Foto (fallback).');
          return;
        }
      }
      $('#preview').srcObject = stream;
      track = stream.getVideoTracks()[0];
      await $('#preview').play();
      $('#btnStart').disabled = true;
      $('#btnStop').disabled = false;
      log('âœ… CÃ¢mera iniciada: ' + (track && (track.label || '(sem label)')));
    }

    function stopCam(){
      try { stream?.getTracks().forEach(t => t.stop()); } catch {}
      stream = null; track = null;
      $('#preview').srcObject = null;
      $('#btnStart').disabled = false;
      $('#btnStop').disabled = true;
      log('â¹ï¸ CÃ¢mera parada.');
    }

    $('#btnStart').addEventListener('click', startCam);
    $('#btnStop').addEventListener('click', stopCam);
    $('#file').addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if (f) log('ðŸ“· Foto escolhida: ' + f.name + ' (' + Math.round(f.size/1024) + ' KB)');
    });
  </script>
</body>
</html>